# CloudFormation - Development Environment

This directory contains CloudFormation templates and scripts for setting up minimal AWS infrastructure for local development.

## Overview

The minimal AWS setup creates only the essential resources needed for local development:

1. **Application Inference Profile** - AWS Bedrock inference profile for Amazon Nova Lite
2. **Secrets Manager Secrets** - JWT secret and provisioning API key
3. **KMS Key** - For encrypting secrets

All other resources (DynamoDB, API service) run locally using Docker/Finch containers.

## Files

- `minimal-aws-setup.yaml` - CloudFormation template
- `deploy.sh` - Deployment script with automatic secret generation
- `cleanup.sh` - Stack deletion script
- `README.md` - This file

## Quick Start

### 1. Deploy Stack

```bash
./deploy.sh
```

This will:
- Generate secure random secrets
- Deploy the CloudFormation stack
- Output resource ARNs
- Create `.env.cloudformation` with configuration
- Verify all resources are accessible

### 2. Update Configuration

The deployment script automatically creates `.env.cloudformation`. Copy these values to your project's `.env` file:

```bash
# From cloudformation/dev directory
cat .env.cloudformation >> ../../.env
```

### 3. Start Local Development

See the [Getting Started Guide](../../docs/getting_started.md) for complete setup instructions.

### 4. Clean Up (Optional)

To delete all AWS resources:

```bash
./cleanup.sh
```

**Warning:** This is permanent and cannot be undone!

## CloudFormation Template Details

### Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| Environment | Environment name | `dev` |
| JWTSecretKey | Base64-encoded JWT secret | Generated by deploy.sh |
| ProvisioningAPIKey | Base64-encoded provisioning API key | Generated by deploy.sh |

### Resources Created

#### 1. Application Inference Profile

- **Type**: `AWS::Bedrock::ApplicationInferenceProfile`
- **Model**: `amazon.nova-lite-v1:0`
- **Name**: `sample-app-nova-lite-dev`
- **Purpose**: Provides access to Amazon Nova Lite model with application-specific tracking

#### 2. KMS Key

- **Type**: `AWS::KMS::Key`
- **Purpose**: Encrypts secrets stored in Secrets Manager
- **Alias**: `alias/bedrock-cost-keeper-dev`

#### 3. JWT Secret

- **Type**: `AWS::SecretsManager::Secret`
- **Name**: `bedrock-cost-keeper/dev/jwt-secret`
- **Purpose**: Signs JWT tokens for API authentication
- **Encryption**: KMS encrypted

#### 4. Provisioning API Secret

- **Type**: `AWS::SecretsManager::Secret`
- **Name**: `bedrock-cost-keeper/dev/provisioning-api-key`
- **Purpose**: Authenticates provisioning API calls
- **Encryption**: KMS encrypted

### Outputs

| Output | Description |
|--------|-------------|
| InferenceProfileArn | ARN of the inference profile |
| InferenceProfileId | ID of the inference profile |
| JWTSecretArn | ARN of JWT secret |
| JWTSecretName | Name of JWT secret |
| ProvisioningAPISecretArn | ARN of provisioning API secret |
| ProvisioningAPISecretName | Name of provisioning API secret |
| KMSKeyArn | ARN of KMS key |
| KMSKeyId | ID of KMS key |

## Usage

### Deploy New Stack

```bash
./deploy.sh
```

### Update Existing Stack

The deployment script automatically detects if the stack exists and updates it:

```bash
./deploy.sh
```

### View Stack Outputs

```bash
aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --query 'Stacks[0].Outputs' \
  --output table
```

### Check Stack Status

```bash
aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --query 'Stacks[0].StackStatus' \
  --output text
```

### Delete Stack

```bash
./cleanup.sh
```

Or manually:

```bash
aws cloudformation delete-stack \
  --stack-name bedrock-cost-keeper-dev-minimal

aws cloudformation wait stack-delete-complete \
  --stack-name bedrock-cost-keeper-dev-minimal
```

## IAM Permissions Required

To deploy this stack, your AWS user/role needs:

### CloudFormation
- `cloudformation:CreateStack`
- `cloudformation:UpdateStack`
- `cloudformation:DescribeStacks`
- `cloudformation:DeleteStack`

### Bedrock
- `bedrock:CreateInferenceProfile`
- `bedrock:DeleteInferenceProfile`
- `bedrock:GetInferenceProfile`
- `bedrock:TagResource`

### Secrets Manager
- `secretsmanager:CreateSecret`
- `secretsmanager:DeleteSecret`
- `secretsmanager:DescribeSecret`
- `secretsmanager:GetSecretValue`
- `secretsmanager:PutSecretValue`
- `secretsmanager:TagResource`

### KMS
- `kms:CreateKey`
- `kms:CreateAlias`
- `kms:DescribeKey`
- `kms:EnableKeyRotation`
- `kms:PutKeyPolicy`
- `kms:ScheduleKeyDeletion`
- `kms:TagResource`

### IAM (for CloudFormation)
- `iam:PassRole` (if using service roles)

## Cost Considerations

This stack creates resources with associated costs:

| Resource | Estimated Cost (Monthly) |
|----------|--------------------------|
| Application Inference Profile | Free (pay per use) |
| Secrets Manager (2 secrets) | ~$0.80 ($0.40/secret) |
| KMS Key | ~$1.00 ($1.00/key) |
| **Total** | **~$1.80/month** |

**Note**: Bedrock invocation costs are additional and depend on usage:
- Amazon Nova Lite: ~$0.00006/1K input tokens, ~$0.00024/1K output tokens

For development/testing with minimal usage, monthly costs should be under $5.

## Troubleshooting

### Stack Creation Fails

**Check CloudFormation events:**
```bash
aws cloudformation describe-stack-events \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --max-items 20
```

**Common issues:**
- Insufficient IAM permissions
- Bedrock not available in region
- Service quotas exceeded

### Inference Profile Not Found

**Verify profile exists:**
```bash
PROFILE_ID=$(aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --query 'Stacks[0].Outputs[?OutputKey==`InferenceProfileId`].OutputValue' \
  --output text)

aws bedrock get-inference-profile \
  --inference-profile-identifier "$PROFILE_ID"
```

### Secrets Not Accessible

**Check secret exists:**
```bash
aws secretsmanager get-secret-value \
  --secret-id bedrock-cost-keeper/dev/jwt-secret
```

**Check KMS permissions:**
```bash
aws kms describe-key \
  --key-id alias/bedrock-cost-keeper-dev
```

### Stack Deletion Fails

**Check for dependent resources:**
```bash
aws cloudformation describe-stack-resources \
  --stack-name bedrock-cost-keeper-dev-minimal
```

**Force delete secrets (if needed):**
```bash
aws secretsmanager delete-secret \
  --secret-id bedrock-cost-keeper/dev/jwt-secret \
  --force-delete-without-recovery

aws secretsmanager delete-secret \
  --secret-id bedrock-cost-keeper/dev/provisioning-api-key \
  --force-delete-without-recovery
```

## Environment-Specific Stacks

To create stacks for different environments:

### Staging

```bash
# Edit deploy.sh to change STACK_NAME and ENVIRONMENT
STACK_NAME="bedrock-cost-keeper-staging-minimal"
ENVIRONMENT="staging"
```

### Production

```bash
# Edit deploy.sh to change STACK_NAME and ENVIRONMENT
STACK_NAME="bedrock-cost-keeper-prod-minimal"
ENVIRONMENT="prod"
```

**Important**: Use different secret values for each environment!

## Security Best Practices

1. **Never commit secrets to git** - The deploy.sh script generates secrets dynamically
2. **Rotate secrets regularly** - Update secrets in Secrets Manager periodically
3. **Use IAM roles** - Prefer IAM roles over access keys where possible
4. **Enable CloudTrail** - Monitor all API calls for security auditing
5. **Restrict access** - Use IAM policies to limit who can access secrets
6. **Use MFA** - Enable MFA for AWS Console and API access

## Next Steps

After deploying the stack:

1. ✅ Copy `.env.cloudformation` values to your `.env` file
2. ✅ Update `test-client/manual_test_config.json` with inference profile ARN
3. ✅ Start local DynamoDB: `./scripts/dynamodb.sh start`
4. ✅ Initialize tables: `./scripts/dynamodb.sh init`
5. ✅ Start API service: `finch-compose up -d api`
6. ✅ Run manual tests: `cd test-client && python manual_test.py`

See [Getting Started Guide](../../docs/getting_started.md) for detailed instructions.

## References

- [AWS CloudFormation Documentation](https://docs.aws.amazon.com/cloudformation/)
- [AWS Bedrock Documentation](https://docs.aws.amazon.com/bedrock/)
- [AWS Secrets Manager Documentation](https://docs.aws.amazon.com/secretsmanager/)
- [Application Inference Profiles](https://docs.aws.amazon.com/bedrock/latest/userguide/inference-profiles.html)

---

**Last Updated**: 2026-01-30
**Version**: 1.0.0
