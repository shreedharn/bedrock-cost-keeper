# CloudFormation - Development Environment

This directory contains CloudFormation templates and scripts for setting up minimal AWS infrastructure for local development.

## Overview

The minimal AWS setup creates only the essential resources needed for local development:

1. **Application Inference Profile** - AWS Bedrock inference profile for Amazon Nova Lite
2. **Secrets Manager Secrets** - JWT secret and provisioning API key
3. **KMS Key** - For encrypting secrets

All other resources (DynamoDB, API service) run locally using Docker/Finch containers.

## Files

- `minimal-aws-setup.yaml` - CloudFormation template
- `deploy.sh` - Deployment script with automatic secret generation
- `cleanup.sh` - Stack deletion script
- `README.md` - This file

**Auto-generated files (not committed to git):**
- `.env.cloudformation` - Generated by `deploy.sh` with stack outputs
- `*.backup` - Backup files created during updates

## Quick Start

### 1. Deploy Stack

```bash
./deploy.sh
```

This will:
- Generate secure random secrets
- Deploy the CloudFormation stack
- Output resource ARNs
- Create `.env.cloudformation` with configuration
- Verify all resources are accessible

### 2. Update Configuration

The deployment script automatically creates `.env.cloudformation`. Copy these values to your project's `.env` file:

```bash
# From cloudformation/dev directory
cat .env.cloudformation >> ../../.env
```

### 3. Start Local Development

See the [Getting Started Guide](../../docs/getting_started.md) for complete setup instructions.

### 4. Clean Up (Optional)

To delete all AWS resources:

```bash
./cleanup.sh
```

**Warning:** This is permanent and cannot be undone!

## CloudFormation Template Details

### Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| Environment | Environment name | `dev` |
| JWTSecretKey | Base64-encoded JWT secret | Generated by deploy.sh |
| ProvisioningAPIKey | Base64-encoded provisioning API key | Generated by deploy.sh |

### Resources Created

#### 1. Application Inference Profile

- **Type**: `AWS::Bedrock::ApplicationInferenceProfile`
- **Model**: `amazon.nova-lite-v1:0`
- **Name**: `sample-app-nova-lite-dev`
- **Purpose**: Provides access to Amazon Nova Lite model with application-specific tracking

#### 2. KMS Key

- **Type**: `AWS::KMS::Key`
- **Purpose**: Encrypts secrets stored in Secrets Manager
- **Alias**: `alias/bedrock-cost-keeper-dev`

#### 3. JWT Secret

- **Type**: `AWS::SecretsManager::Secret`
- **Name**: `bedrock-cost-keeper/dev/jwt-secret`
- **Purpose**: Signs JWT tokens for API authentication
- **Encryption**: KMS encrypted

#### 4. Provisioning API Secret

- **Type**: `AWS::SecretsManager::Secret`
- **Name**: `bedrock-cost-keeper/dev/provisioning-api-key`
- **Purpose**: Authenticates provisioning API calls
- **Encryption**: KMS encrypted

### Outputs

| Output | Description |
|--------|-------------|
| InferenceProfileArn | ARN of the inference profile |
| InferenceProfileId | ID of the inference profile |
| JWTSecretArn | ARN of JWT secret |
| JWTSecretName | Name of JWT secret |
| ProvisioningAPISecretArn | ARN of provisioning API secret |
| ProvisioningAPISecretName | Name of provisioning API secret |
| KMSKeyArn | ARN of KMS key |
| KMSKeyId | ID of KMS key |

## Usage

### Deploy New Stack

```bash
./deploy.sh
```

### Update Existing Stack

The deployment script automatically detects if the stack exists and updates it:

```bash
./deploy.sh
```

### View Stack Outputs

```bash
aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --query 'Stacks[0].Outputs' \
  --output table
```

### Check Stack Status

```bash
aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --query 'Stacks[0].StackStatus' \
  --output text
```

### Delete Stack

```bash
./cleanup.sh
```

Or manually:

```bash
aws cloudformation delete-stack \
  --stack-name bedrock-cost-keeper-dev-minimal

aws cloudformation wait stack-delete-complete \
  --stack-name bedrock-cost-keeper-dev-minimal
```

## Stack Tagging

The deployment script supports adding custom tags to the CloudFormation stack and all resources created by it. Tags help with cost allocation, resource organization, access control policies, and compliance.

### Basic Usage

Deploy without tags:
```bash
./deploy.sh
```

Deploy with tags:
```bash
./deploy.sh --tag KEY=VALUE
```

Deploy with multiple tags:
```bash
./deploy.sh --tag Environment=dev --tag Project=BedrockCostKeeper --tag Owner=TeamA
```

Custom region with tags:
```bash
./deploy.sh --region us-west-2 --tag Environment=prod --tag CostCenter=Engineering
```

### Common Tagging Patterns

**Environment tagging:**
```bash
# Development
./deploy.sh --tag Environment=dev --tag Purpose=development

# Staging
./deploy.sh --tag Environment=staging --tag Purpose=testing

# Production
./deploy.sh --tag Environment=prod --tag Purpose=production
```

**Cost allocation tags:**
```bash
./deploy.sh \
  --tag CostCenter=Engineering \
  --tag Department=AI-ML \
  --tag Project=BedrockCostKeeper \
  --tag Budget=Q1-2026
```

**Organizational tags:**
```bash
./deploy.sh \
  --tag Owner=john.doe@company.com \
  --tag Team=Platform-Engineering \
  --tag ManagedBy=CloudFormation \
  --tag Application=bedrock-cost-keeper
```

**Compliance tags:**
```bash
./deploy.sh \
  --tag Compliance=HIPAA \
  --tag DataClassification=Internal \
  --tag BackupRequired=true \
  --tag RetentionPeriod=7-years
```

### Recommended Minimum Tags

```bash
./deploy.sh \
  --tag Environment=dev \
  --tag Project=BedrockCostKeeper \
  --tag Owner=team@company.com \
  --tag ManagedBy=CloudFormation
```

### Tag Naming Conventions

- **Use PascalCase** for tag keys: `Environment`, `CostCenter`, `ProjectName`
- **Use lowercase or descriptive values**: `dev`, `engineering`, `bedrock-cost-keeper`
- **Avoid spaces** in tag values (use hyphens or underscores)
- **Be consistent** across all deployments

### AWS Tag Limits

- Maximum 50 tags per resource
- Tag keys: 1-128 characters
- Tag values: 0-256 characters
- Allowed characters: letters, numbers, spaces, and `+ - = . _ : / @`

### Tag Propagation

Tags specified with `--tag` are applied to:
1. CloudFormation Stack itself
2. All resources created by the stack that support tagging (Secrets Manager secrets, inference profiles, IAM roles, etc.)

### Viewing Tags

**View stack tags:**
```bash
aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --region us-east-1 \
  --query 'Stacks[0].Tags'
```

**View resource tags:**
```bash
# List stack resources
aws cloudformation list-stack-resources \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --region us-east-1

# View tags on a specific resource
aws secretsmanager describe-secret \
  --secret-id bedrock-cost-keeper/dev/jwt-secret \
  --region us-east-1 \
  --query 'Tags'
```

### Cost Allocation with Tags

1. Go to AWS Billing Console → Cost Allocation Tags
2. Activate your custom tags (e.g., `Project`, `CostCenter`, `Environment`)
3. Wait 24 hours for tags to appear in Cost Explorer

**Example cost report:**
```bash
aws ce get-cost-and-usage \
  --time-period Start=2026-01-01,End=2026-02-01 \
  --granularity MONTHLY \
  --metrics BlendedCost \
  --group-by Type=TAG,Key=Project
```

### Updating Tags on Existing Stack

Re-run deployment with new/updated tags:
```bash
./deploy.sh \
  --tag Environment=dev \
  --tag CostCenter=NewDepartment \
  --tag UpdatedAt=2026-02-01
```

CloudFormation will update the stack tags without recreating resources.

## IAM Permissions Required

To deploy this stack, your AWS user/role needs:

### CloudFormation
- `cloudformation:CreateStack`
- `cloudformation:UpdateStack`
- `cloudformation:DescribeStacks`
- `cloudformation:DeleteStack`

### Bedrock
- `bedrock:CreateInferenceProfile`
- `bedrock:DeleteInferenceProfile`
- `bedrock:GetInferenceProfile`
- `bedrock:TagResource`

### Secrets Manager
- `secretsmanager:CreateSecret`
- `secretsmanager:DeleteSecret`
- `secretsmanager:DescribeSecret`
- `secretsmanager:GetSecretValue`
- `secretsmanager:PutSecretValue`
- `secretsmanager:TagResource`

### KMS
- `kms:CreateKey`
- `kms:CreateAlias`
- `kms:DescribeKey`
- `kms:EnableKeyRotation`
- `kms:PutKeyPolicy`
- `kms:ScheduleKeyDeletion`
- `kms:TagResource`

### IAM (for CloudFormation)
- `iam:PassRole` (if using service roles)

## Cost Considerations

This stack creates resources with associated costs:

| Resource | Estimated Cost (Monthly) |
|----------|--------------------------|
| Application Inference Profile | Free (pay per use) |
| Secrets Manager (2 secrets) | ~$0.80 ($0.40/secret) |
| KMS Key | ~$1.00 ($1.00/key) |
| **Total** | **~$1.80/month** |

**Note**: Bedrock invocation costs are additional and depend on usage:
- Amazon Nova Lite: ~$0.00006/1K input tokens, ~$0.00024/1K output tokens

For development/testing with minimal usage, monthly costs should be under $5.

## Troubleshooting

### Stack Creation Fails

**Check CloudFormation events:**
```bash
aws cloudformation describe-stack-events \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --max-items 20
```

**Common issues:**
- Insufficient IAM permissions
- Bedrock not available in region
- Service quotas exceeded

### Inference Profile Not Found

**Verify profile exists:**
```bash
PROFILE_ID=$(aws cloudformation describe-stacks \
  --stack-name bedrock-cost-keeper-dev-minimal \
  --query 'Stacks[0].Outputs[?OutputKey==`InferenceProfileId`].OutputValue' \
  --output text)

aws bedrock get-inference-profile \
  --inference-profile-identifier "$PROFILE_ID"
```

### Secrets Not Accessible

**Check secret exists:**
```bash
aws secretsmanager get-secret-value \
  --secret-id bedrock-cost-keeper/dev/jwt-secret
```

**Check KMS permissions:**
```bash
aws kms describe-key \
  --key-id alias/bedrock-cost-keeper-dev
```

### Stack Deletion Fails

**Check for dependent resources:**
```bash
aws cloudformation describe-stack-resources \
  --stack-name bedrock-cost-keeper-dev-minimal
```

**Force delete secrets (if needed):**
```bash
aws secretsmanager delete-secret \
  --secret-id bedrock-cost-keeper/dev/jwt-secret \
  --force-delete-without-recovery

aws secretsmanager delete-secret \
  --secret-id bedrock-cost-keeper/dev/provisioning-api-key \
  --force-delete-without-recovery
```

## Environment-Specific Stacks

To create stacks for different environments:

### Staging

```bash
# Edit deploy.sh to change STACK_NAME and ENVIRONMENT
STACK_NAME="bedrock-cost-keeper-staging-minimal"
ENVIRONMENT="staging"
```

### Production

```bash
# Edit deploy.sh to change STACK_NAME and ENVIRONMENT
STACK_NAME="bedrock-cost-keeper-prod-minimal"
ENVIRONMENT="prod"
```

**Important**: Use different secret values for each environment!

## Security Best Practices

1. **Never commit secrets to git** - The deploy.sh script generates secrets dynamically
2. **Rotate secrets regularly** - Update secrets in Secrets Manager periodically
3. **Use IAM roles** - Prefer IAM roles over access keys where possible
4. **Enable CloudTrail** - Monitor all API calls for security auditing
5. **Restrict access** - Use IAM policies to limit who can access secrets
6. **Use MFA** - Enable MFA for AWS Console and API access

## Next Steps

After deploying the stack:

1. ✅ Copy `.env.cloudformation` values to your `.env` file
2. ✅ Update `test-client/manual_test_config.json` with inference profile ARN
3. ✅ Start local DynamoDB: `./scripts/dynamodb.sh start`
4. ✅ Initialize tables: `./scripts/dynamodb.sh init`
5. ✅ Start API service: `finch-compose up -d api`
6. ✅ Run manual tests: `cd test-client && python manual_test.py`

See [Getting Started Guide](../../docs/getting_started.md) for detailed instructions.

## References

- [AWS CloudFormation Documentation](https://docs.aws.amazon.com/cloudformation/)
- [AWS Bedrock Documentation](https://docs.aws.amazon.com/bedrock/)
- [AWS Secrets Manager Documentation](https://docs.aws.amazon.com/secretsmanager/)
- [Application Inference Profiles](https://docs.aws.amazon.com/bedrock/latest/userguide/inference-profiles.html)

---

**Last Updated**: 2026-01-30
**Version**: 1.0.0
